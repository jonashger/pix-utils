"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t,e=require("buffer"),n=(t=require("axios"))&&"object"==typeof t&&"default"in t?t.default:t,r=require("qrcode");function a(t,e,n,r,a,i,o){try{var s=t[i](o),u=s.value}catch(t){return void n(t)}s.done?e(u):Promise.resolve(u).then(r,a)}function i(t){return function(){var e=this,n=arguments;return new Promise((function(r,i){var o=t.apply(e,n);function s(t){a(o,r,i,s,u,"next",t)}function u(t){a(o,r,i,s,u,"throw",t)}s(void 0)}))}}function o(){return(o=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t}).apply(this,arguments)}function s(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,c(t,e)}function u(t){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function c(t,e){return(c=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function l(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function f(t,e,n){return(f=l()?Reflect.construct:function(t,e,n){var r=[null];r.push.apply(r,e);var a=new(Function.bind.apply(t,r));return n&&c(a,n.prototype),a}).apply(null,arguments)}function h(t){var e="function"==typeof Map?new Map:void 0;return(h=function(t){if(null===t||-1===Function.toString.call(t).indexOf("[native code]"))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,n)}function n(){return f(t,arguments,u(this).constructor)}return n.prototype=Object.create(t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),c(n,t)})(t)}function p(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function d(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(n)return(n=n.call(t)).next.bind(n);if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return p(t,void 0);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?p(t,void 0):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0;return function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var m,A,T=(function(t){var e=function(t){var e=Object.prototype,n=e.hasOwnProperty,r="function"==typeof Symbol?Symbol:{},a=r.iterator||"@@iterator",i=r.asyncIterator||"@@asyncIterator",o=r.toStringTag||"@@toStringTag";function s(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{s({},"")}catch(t){s=function(t,e,n){return t[e]=n}}function u(t,e,n,r){var a=Object.create((e&&e.prototype instanceof f?e:f).prototype),i=new y(r||[]);return a._invoke=function(t,e,n){var r="suspendedStart";return function(a,i){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===a)throw i;return{value:void 0,done:!0}}for(n.method=a,n.arg=i;;){var o=n.delegate;if(o){var s=_(o,n);if(s){if(s===l)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var u=c(t,e,n);if("normal"===u.type){if(r=n.done?"completed":"suspendedYield",u.arg===l)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(r="completed",n.method="throw",n.arg=u.arg)}}}(t,n,i),a}function c(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}t.wrap=u;var l={};function f(){}function h(){}function p(){}var d={};d[a]=function(){return this};var m=Object.getPrototypeOf,A=m&&m(m(M([])));A&&A!==e&&n.call(A,a)&&(d=A);var T=p.prototype=f.prototype=Object.create(d);function E(t){["next","throw","return"].forEach((function(e){s(t,e,(function(t){return this._invoke(e,t)}))}))}function I(t,e){var r;this._invoke=function(a,i){function o(){return new e((function(r,o){!function r(a,i,o,s){var u=c(t[a],t,i);if("throw"!==u.type){var l=u.arg,f=l.value;return f&&"object"==typeof f&&n.call(f,"__await")?e.resolve(f.__await).then((function(t){r("next",t,o,s)}),(function(t){r("throw",t,o,s)})):e.resolve(f).then((function(t){l.value=t,o(l)}),(function(t){return r("throw",t,o,s)}))}s(u.arg)}(a,i,r,o)}))}return r=r?r.then(o,o):o()}}function _(t,e){var n=t.iterator[e.method];if(void 0===n){if(e.delegate=null,"throw"===e.method){if(t.iterator.return&&(e.method="return",e.arg=void 0,_(t,e),"throw"===e.method))return l;e.method="throw",e.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var r=c(n,t.iterator,e.arg);if("throw"===r.type)return e.method="throw",e.arg=r.arg,e.delegate=null,l;var a=r.arg;return a?a.done?(e[t.resultName]=a.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,l):a:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,l)}function v(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function g(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function y(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(v,this),this.reset(!0)}function M(t){if(t){var e=t[a];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,i=function e(){for(;++r<t.length;)if(n.call(t,r))return e.value=t[r],e.done=!1,e;return e.value=void 0,e.done=!0,e};return i.next=i}}return{next:C}}function C(){return{value:void 0,done:!0}}return h.prototype=T.constructor=p,p.constructor=h,h.displayName=s(p,o,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===h||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,p):(t.__proto__=p,s(t,o,"GeneratorFunction")),t.prototype=Object.create(T),t},t.awrap=function(t){return{__await:t}},E(I.prototype),I.prototype[i]=function(){return this},t.AsyncIterator=I,t.async=function(e,n,r,a,i){void 0===i&&(i=Promise);var o=new I(u(e,n,r,a),i);return t.isGeneratorFunction(n)?o:o.next().then((function(t){return t.done?t.value:o.next()}))},E(T),s(T,o,"Generator"),T[a]=function(){return this},T.toString=function(){return"[object Generator]"},t.keys=function(t){var e=[];for(var n in t)e.push(n);return e.reverse(),function n(){for(;e.length;){var r=e.pop();if(r in t)return n.value=r,n.done=!1,n}return n.done=!0,n}},t.values=M,y.prototype={constructor:y,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(g),!t)for(var e in this)"t"===e.charAt(0)&&n.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function r(n,r){return o.type="throw",o.arg=t,e.next=n,r&&(e.method="next",e.arg=void 0),!!r}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],o=i.completion;if("root"===i.tryLoc)return r("end");if(i.tryLoc<=this.prev){var s=n.call(i,"catchLoc"),u=n.call(i,"finallyLoc");if(s&&u){if(this.prev<i.catchLoc)return r(i.catchLoc,!0);if(this.prev<i.finallyLoc)return r(i.finallyLoc)}else if(s){if(this.prev<i.catchLoc)return r(i.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return r(i.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc<=this.prev&&n.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var i=a;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=t,o.arg=e,i?(this.method="next",this.next=i.finallyLoc,l):this.complete(o)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),l},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),g(n),l}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var a=r.arg;g(n)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,n){return this.delegate={iterator:M(t),resultName:e,nextLoc:n},"next"===this.method&&(this.arg=void 0),l}},t}(t.exports);try{regeneratorRuntime=e}catch(t){Function("r","regeneratorRuntime = r")(e)}}(A={exports:{}}),A.exports);function E(t){return I.apply(this,arguments)}function I(){return(I=i(T.mark((function t(r){return T.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",n.get("https://"+r.url,{headers:{},params:{DPP:r.DPP,codMun:r.codMun}}).then((function(t){var e=t.data,n=t.status;if(200!==n)throw new Error("HTTP "+n);return e})).then((function(t){var n=t.split(".").map((function(t){return e.Buffer.from(t,"base64")}));return{jwsString:t,jws:{hdr:n[0],payload:n[1],signature:n[2]},header:JSON.parse(n[0].toString()),payload:JSON.parse(n[1].toString())}})).catch((function(t){throw console.log(t),t})));case 3:case"end":return t.stop()}}),t)})))).apply(this,arguments)}!function(t){t[t.TAG_INIT=0]="TAG_INIT",t[t.TAG_CRC=63]="TAG_CRC",t[t.TAG_MAX=99]="TAG_MAX",t[t.TAG_ONETIME_PAYMENT=2]="TAG_ONETIME_PAYMENT",t[t.TAG_MCC=52]="TAG_MCC",t[t.TAG_TRANSACTION_CURRENCY=53]="TAG_TRANSACTION_CURRENCY",t[t.TAG_TRANSACTION_AMOUNT=54]="TAG_TRANSACTION_AMOUNT",t[t.TAG_COUNTRY_CODE=58]="TAG_COUNTRY_CODE",t[t.TAG_MERCHANT_NAME=59]="TAG_MERCHANT_NAME",t[t.TAG_MERCHANT_CITY=60]="TAG_MERCHANT_CITY",t[t.MAI_STANDARD_FIRST=2]="MAI_STANDARD_FIRST",t[t.MAI_TEMPLATE_FIRST=26]="MAI_TEMPLATE_FIRST",t[t.MAI_TEMPLATE_LAST=51]="MAI_TEMPLATE_LAST",t[t.TAG_TEMPLATE_GUI=0]="TAG_TEMPLATE_GUI",t[t.TAG_ADDITIONAL_DATA=62]="TAG_ADDITIONAL_DATA",t[t.TAG_AD_REF_LABEL=5]="TAG_AD_REF_LABEL"}(m||(m={}));var _={0:{name:"Globally Unique Identifier",length:{max:32},optional:!0},1:{lastTag:99,name:"Payment System specific",optional:!0}},v={name:"root",elementMap:{0:{name:"Payload Format Indicator",length:2,pattern:/^01$/},1:{name:"Point of Initiation Method",optional:!0,length:2,pattern:/^1[12]$/},2:{lastTag:25,name:"Merchant Account Information",length:{max:99}},26:{lastTag:51,name:"Merchant Account Information",elementMap:_},52:{name:"Merchant Category Code",length:4,pattern:/^\d*$/},53:{name:"Transaction Currency",length:3,pattern:/^\d*$/},54:{name:"Transaction Amount",length:{max:13},pattern:/^[\d]+(.\d\d)?$/},55:{name:"Tip or Convenience Indicator",length:2,optional:!0},56:{name:"Value of Convenience Fee Fixed",length:{max:13},pattern:/^[\d]+(.\d\d)?$/},57:{name:"Value of Convenience Fee Percentage"},58:{name:"Country Code",length:2},59:{name:"Merchant Name",length:{max:25}},60:{name:"Merchant City"},61:{name:"Postal Code",optional:!0},62:{name:"Additional Data Field Template",optional:!0,elementMap:{1:{name:"Bill Number",length:{max:25},optional:!0},2:{name:"Mobile Number",length:{max:25},optional:!0},3:{name:"Store Label",length:{max:25},optional:!0},4:{name:"Loyalty Number",length:{max:25},optional:!0},5:{name:"Reference Label",length:{max:25},optional:!0},6:{name:"Customer Label",length:{max:25},optional:!0},7:{name:"Terminal Label",length:{max:25},optional:!0},8:{name:"Purpose of Transaction",length:{max:25},optional:!0},9:{name:"Additional Consumer Data Request",length:{max:25},optional:!0},10:{lastTag:49,name:"RFU for EMVCo",optional:!0},50:{lastTag:99,name:"Payment System specific template",optional:!0,elementMap:_}}},63:{name:"CRC",pattern:/^[A-Fa-f\d]*$/},64:{name:"Merchant Information — Language Template",optional:!0,elementMap:{0:{name:"Language Preference",optional:!0},1:{name:"Merchant Name - Alternate Language",optional:!0},3:{name:"Merchant City - Alternate Language",optional:!0}}},65:{lastTag:79,name:"RFU for EMVCo",optional:!0},80:{lastTag:99,name:"Unreserved Templates",optional:!0,elementMap:{0:{name:"Globally Unique Identifier",length:{max:32},optional:!0},1:{lastTag:99,name:"Context specific data",optional:!0}}}}};function g(t,e){void 0===e&&(e=!1);for(var n=(new TextEncoder).encode(t),r=[0,4129,8258,12387,16516,20645,24774,28903,33032,37161,41290,45419,49548,53677,57806,61935,4657,528,12915,8786,21173,17044,29431,25302,37689,33560,45947,41818,54205,50076,62463,58334,9314,13379,1056,5121,25830,29895,17572,21637,42346,46411,34088,38153,58862,62927,50604,54669,13907,9842,5649,1584,30423,26358,22165,18100,46939,42874,38681,34616,63455,59390,55197,51132,18628,22757,26758,30887,2112,6241,10242,14371,51660,55789,59790,63919,35144,39273,43274,47403,23285,19156,31415,27286,6769,2640,14899,10770,56317,52188,64447,60318,39801,35672,47931,43802,27814,31879,19684,23749,11298,15363,3168,7233,60846,64911,52716,56781,44330,48395,36200,40265,32407,28342,24277,20212,15891,11826,7761,3696,65439,61374,57309,53244,48923,44858,40793,36728,37256,33193,45514,41451,53516,49453,61774,57711,4224,161,12482,8419,20484,16421,28742,24679,33721,37784,41979,46042,49981,54044,58239,62302,689,4752,8947,13010,16949,21012,25207,29270,46570,42443,38312,34185,62830,58703,54572,50445,13538,9411,5280,1153,29798,25671,21540,17413,42971,47098,34713,38840,59231,63358,50973,55100,9939,14066,1681,5808,26199,30326,17941,22068,55628,51565,63758,59695,39368,35305,47498,43435,22596,18533,30726,26663,6336,2273,14466,10403,52093,56156,60223,64286,35833,39896,43963,48026,19061,23124,27191,31254,2801,6864,10931,14994,64814,60687,56684,52557,48554,44427,40424,36297,31782,27655,23652,19525,15522,11395,7392,3265,61215,65342,53085,57212,44955,49082,36825,40952,28183,32310,20053,24180,11923,16050,3793,7920],a=65535,i=0;i<n.length;i++)a=r[255&(n[i]^a>>8)]^a<<8;var o=function(t,e){var n=t.toString(16).toUpperCase();return("0".repeat(4)+n).slice(-4)}(65535&(0^a));return e?o.slice(2)+o.slice(0,2):o}var y,M=function(t){function e(e,n){var r;return(r=t.call(this,n)||this).errorCode=e,r.errorName="",r}return s(e,t),e}(h(Error)),C=function(){function t(t){this.childValidators=[],this.result={status:"none"},this.ruleInfo=t}t.get=function(e){return new t(e)};var e=t.prototype;return e.addRule=function(e){return this.addValidator(t.get(e))},e.addValidator=function(t){return t.parent=this,this.childValidators.push(t),this},e.handleResult=function(t,e,n){void 0===n&&(n=!1);var r=this.result.status;switch(t.status){case"none":case"not-applicable":case"running":this.result=t;break;case"pass":n&&"running"===this.result.status&&(this.result=t);break;case"inconclusive":case"fail":"fail"!==this.result.status&&(this.result=t)}return e&&r!==this.result.status&&e(this,this.result),this.result},e.executeRule=function(){var t=i(T.mark((function t(e){var n,r;return T.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n={status:"pass"},!this.ruleInfo.rule){t.next=18;break}if(t.prev=2,!(r=this.ruleInfo.rule(e,this))){t.next=13;break}if(!(r instanceof Promise)){t.next=11;break}return t.next=8,Promise.resolve(r);case 8:t.t0=t.sent,t.next=12;break;case 11:t.t0=r;case 12:n=t.t0;case 13:t.next=18;break;case 15:t.prev=15,t.t1=t.catch(2),n={status:"fail",error:t.t1 instanceof M?t.t1:new M(t.t1)};case 18:return t.abrupt("return",n);case 19:case"end":return t.stop()}}),t,this,[[2,15]])})));return function(e){return t.apply(this,arguments)}}(),e.validate=function(){var t=i(T.mark((function t(e,n){var r,a,i;return T.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.result={status:"none"},this.ruleInfo.when&&!this.ruleInfo.when(e,this)){t.next=25;break}if(this.handleResult({status:"running"},n),!this.ruleInfo.rule){t.next=11;break}return t.t0=this,t.next=8,this.executeRule(e);case 8:t.t1=t.sent,t.t2=n,t.t0.handleResult.call(t.t0,t.t1,t.t2);case 11:r=d(this.childValidators);case 12:if((a=r()).done){t.next=22;break}if(i=a.value,"running"===this.result.status){t.next=16;break}return t.abrupt("break",22);case 16:return t.next=18,i.validate(e,n);case 18:this.handleResult(t.sent,n);case 20:t.next=12;break;case 22:"running"===this.result.status&&this.handleResult({status:"pass"},n,!0),t.next=26;break;case 25:this.handleResult({status:"not-applicable"},n,!0);case 26:return t.abrupt("return",this.result);case 27:case"end":return t.stop()}}),t,this)})));return function(e,n){return t.apply(this,arguments)}}(),t}();!function(t){t[t.INVALID_PARAM=0]="INVALID_PARAM",t[t.INVALID_QRCODE=1]="INVALID_QRCODE",t[t.CRC_MISMATCH=2]="CRC_MISMATCH",t[t.MISSING_MANDATORY_ELEMENT=3]="MISSING_MANDATORY_ELEMENT",t[t.INVALID_ELEMENT=4]="INVALID_ELEMENT"}(y||(y={}));var w=function(t){function e(e,n){var r;return(r=t.call(this,e,n)||this).errorCode=e,r.errorName="EMVQR-"+y[e],r}return s(e,t),e}(M),N=[m.TAG_INIT,m.TAG_MCC,m.TAG_TRANSACTION_CURRENCY,m.TAG_COUNTRY_CODE,m.TAG_MERCHANT_NAME,m.TAG_MERCHANT_CITY,m.TAG_CRC];function R(t,e,n){void 0===n&&(n=""),t.isType("data")?function(t,e,n){if(t){if(null!=e&&e.length)if(e.length instanceof Object){var r=e.length;if(r.max&&t.length>r.max)throw new w(y.INVALID_ELEMENT,"Element "+n+" must have maximum length of "+r.max);if(r.min&&t.length<r.min)throw new w(y.INVALID_ELEMENT,"Element "+n+" must have minimum length of "+r.min)}else if(t.length!==e.length)throw new w(y.INVALID_ELEMENT,"Element "+n+" must have length of "+e.length);if(null!=e&&e.pattern&&!(e.pattern instanceof RegExp?e.pattern:new RegExp(e.pattern)).test(t))throw new w(y.INVALID_ELEMENT,"Element "+n+" has invalid contents")}else if(!e.optional)throw new w(y.MISSING_MANDATORY_ELEMENT,"Element "+n+" missing and is mandatory")}(t.content,e,n):t.elements.forEach((function(r){R(r,function(t,e,n){var r,a=null==t?void 0:t.elementMap;if(null!=t&&t.identifiedElementMap&&e.hasElement(m.TAG_TEMPLATE_GUI)){var i=e.getElement(m.TAG_TEMPLATE_GUI).content.toUpperCase();for(var s in t.identifiedElementMap)s.toUpperCase()===i&&(a=o({},a,t.identifiedElementMap[s]))}var u={name:"Unknown",elementMap:{}};if(null!=(r=a)&&r[n])u=a[n];else for(var c in a){var l=parseInt(c),f=a[l];n>=l&&f.lastTag&&n<=f.lastTag&&(u=f)}return u}(e,t,r.tag),n+(n.length?":":"")+("00"+r.tag).slice(-2))}))}var L,D=function(){function t(t,e,n,r){switch(void 0===r&&(r=0),this.type=t,this.baseOffset=r,this.content=e,t){case"root":case"template":this.elements=this.parseElementSequence(e,r);break;default:this.elements=new Map}n&&(this.tag=n)}var e=t.prototype;return e.isType=function(t){return this.type===t},e.isTemplate=function(){return this.isType("template")||this.isType("identified-template")},e.parseElementSequence=function(e,n){void 0===n&&(n=0);for(var r=new Map,a=e.length,i=0;i+4<a;){var o=n+i;if(!/^\d{4}$/.test(e.substr(i,4)))throw new w(y.INVALID_QRCODE,"Error parsing qrcode string: invalid tag or length characters @ "+(1+o));var s=parseInt(e.substr(i,2)),u=parseInt(e.substr(i+2,2));if(i+u+4>a)throw new w(y.INVALID_QRCODE,"Error parsing qrcode string: invalid length @"+(1+o));var c=e.substr(i+2+2,u);r.set(s,new t("data",c,s,o)),i+=4+u}if(i!==a)throw new w(y.INVALID_QRCODE,"Error parsing qrcode string: extra characters at end @"+(1+n+i));return r},e.parseAsTemplate=function(t){return this.isTemplate()||(this.elements=this.parseElementSequence(this.content,this.baseOffset),this.type=t?"identified-template":"template"),this},e.hasElement=function(t){return this.elements.has(t)},e.getElement=function(e){return this.elements.has(e)?this.elements.get(e):new t("void","",e)},e.newDataElement=function(e,n){var r=new t("data",n,e);return this.elements.set(e,r),r},e.newTemplateElement=function(e,n,r,a){for(void 0===r&&(r=!1),n||(n=e);e<=n;){if(!this.hasElement(e)){var i=new t(r?"identified-template":"template","",e);if(a)for(var o,s=d(a);!(o=s()).done;){var u=o.value;i.elements.set(u.tag,u)}return this.elements.set(e,i),i}++e}throw new w(y.INVALID_ELEMENT,"Unable to insert template")},e.deleteElement=function(t){this.elements.delete(t)},e.toJSON=function(){var t;return{type:this.type,tag:null!=(t=this.tag)?t:void 0,content:this.content,elements:this.isType("data")?void 0:Array.from(this.elements.values()).map((function(t){return t.toJSON()}))}},e.ensureDataElement=function(t,e){return void 0===e&&(e=""),this.hasElement(t)?this.getElement(t):this.newDataElement(t,e)},e.buildTagLength=function(){return("00"+this.tag.toString()).slice(-2)+("00"+this.content.length.toString()).slice(-2)},e.buildQRString=function(t){void 0===t&&(t=0);var e=this.isType("root");if(e&&console.log(this.elements),this.baseOffset=t,e||(t+=4),!this.isType("data")){var n=[];this.elements.forEach((function(r){if(!(e&&(i=[m.TAG_INIT,m.TAG_CRC],o=r.tag,i.indexOf(o)>=0))){var a=r.buildQRString(t);n.push(a),t+=a.length}var i,o})),this.content=n.join("")}return e?this.content:this.buildTagLength()+this.content},e.findIdentifiedTemplate=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n=m.TAG_MAX);var r=[];return this.elements.forEach((function(a){a.isType("identified-template")&&a.tag>=e&&a.tag<=n&&a.hasElement(m.TAG_TEMPLATE_GUI)&&a.getElement(m.TAG_TEMPLATE_GUI).content.toUpperCase()===t.toUpperCase()&&r.push(a)})),r},t}(),b={encoding:"utf8"},x=function(t){function e(e,n){var r;return(r=t.call(this,"root",function(t,e){switch(void 0===t&&(t=""),void 0===e&&(e="utf8"),e){case"utf8":return t;case"base64":var n=Buffer.from(t,"base64");return(new TextDecoder).decode(n);default:throw new w(y.INVALID_PARAM,"encoding must be 'utf8' or 'base64'")}}(e,n.encoding))||this).type="root",r}s(e,t),e.createCode=function(t){var n=new e("",{encoding:"utf8"});return t&&(n.newDataElement(m.TAG_MCC,t.merchantCategoryCode),n.newDataElement(m.TAG_TRANSACTION_CURRENCY,("000"+t.transactionCurrency).slice(-3)),n.newDataElement(m.TAG_COUNTRY_CODE,t.countryCode),n.newDataElement(m.TAG_MERCHANT_NAME,t.merchantName),n.newDataElement(m.TAG_MERCHANT_CITY,t.merchantCity),t.oneTime&&n.newDataElement(m.TAG_ONETIME_PAYMENT,"12"),t.transactionAmount&&n.newDataElement(m.TAG_TRANSACTION_AMOUNT,t.transactionAmount.toFixed(2))),n},e.parseCode=function(t,n){var r=new e(t,n=o({},b,n));function a(t,e,n,r){for(var a=n;a<=(null!=r?r:n);++a)t.hasElement(a)&&t.getElement(a).parseAsTemplate(e)}return a(r,!0,m.MAI_TEMPLATE_FIRST,m.MAI_TEMPLATE_LAST),r.hasElement(m.TAG_ADDITIONAL_DATA)&&(a(r,!1,m.TAG_ADDITIONAL_DATA),a(r.getElement(m.TAG_ADDITIONAL_DATA),!0,50,99)),a(r,!1,64),a(r,!0,80,99),r};var n=e.prototype;return n.getDataElement=function(t){return this.hasElement(t)?this.getElement(t).content:""},n.extractElements=function(){return{merchantCategoryCode:this.getDataElement(m.TAG_MCC),transactionCurrency:Number(+this.getDataElement(m.TAG_TRANSACTION_CURRENCY)),countryCode:this.getDataElement(m.TAG_COUNTRY_CODE),merchantName:this.getDataElement(m.TAG_MERCHANT_NAME),merchantCity:this.getDataElement(m.TAG_MERCHANT_CITY),transactionAmount:Number(+this.getDataElement(m.TAG_TRANSACTION_AMOUNT)),oneTime:"12"===this.getDataElement(m.TAG_ONETIME_PAYMENT)}},n.validateCode=function(){var t=i(T.mark((function t(e){return T.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",C.get({id:"EMVQR"}).addRule({id:"start-element-00",description:"Initial element is '00' with contents '01'",rule:function(t){if(0!==t.getElement(0).baseOffset)throw new w(y.INVALID_QRCODE,"Missing start element (00)");if("01"!==t.getElement(0).content)throw new w(y.INVALID_QRCODE,"Invalid value for start element (00)")}}).addRule({id:"final-element-63",description:"Final element is CRC '63'",rule:function(t){if(t.getElement(m.TAG_CRC).baseOffset!==t.content.length-8||"6304"!==t.content.slice(-8,-4))throw new w(y.INVALID_QRCODE,"CRC must be final element (63)")}}).addRule({id:"valid-crc",description:"CRC is valid",rule:function(t){var e=t.getElement(m.TAG_CRC);if(g(t.content.slice(0,-4))!==e.content)throw new w(y.CRC_MISMATCH,"Invalid CRC")}}).addRule({id:"one-or-more-mai",description:"Contains one or more Merchant Account Information elements",rule:function(t){if(0===Array.from(t.elements.keys()).filter((function(t){return t>=2&&t<=51})).length)throw new w(y.MISSING_MANDATORY_ELEMENT,"Must have at least one Merchant Account Information")}}).addRule({id:"mandatory-elements",description:"Contains EMV mandatory elements",rule:function(t){N.forEach((function(e){if(!t.hasElement(e))throw new w(y.MISSING_MANDATORY_ELEMENT,"Missing mandatory tag ("+e+")")}))}}).addRule({id:"valid-elements",description:"Elements are valid",rule:function(t){R(t,v)}}).validate(this,e));case 1:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}(),n.buildQRString=function(){var e=this.content;e=this.ensureDataElement(0,"01").buildQRString(),e+=t.prototype.buildQRString.call(this,e.length);var n=g(e+=this.newDataElement(m.TAG_CRC,"0000").buildQRString(e.length).slice(0,-4));return this.getElement(m.TAG_CRC).content=n,this.baseOffset=0,this.content=e+=n,e},n.dumpNode=function(t,e,n){var r=this;void 0===t&&(t=this);var a="";return t.isType("data")?(a+=n+" "+("00"+t.tag).slice(-2)+" ("+e.name+")\n",a+=n+" "+t.content+"\n"):(t.isType("root")||(a+=n+"("+("00"+t.tag).slice(-2)+"): "+e.name+"\n",n+="  "),t.elements.forEach((function(t){var i,o,s=null!=(i=null==e||null==(o=e.elementMap)?void 0:o[t.tag])?i:{name:"unknown",elementMap:{}};a+=r.dumpNode(t,s,n)}))),a},e}(D);!function(t){t[t.OK=0]="OK",t[t.INVALID_QRCODE=1]="INVALID_QRCODE",t[t.CRC_MISMATCH=2]="CRC_MISMATCH",t[t.MISSING_MANDATORY_ELEMENT=3]="MISSING_MANDATORY_ELEMENT",t[t.MISSING_PIX_MAI=4]="MISSING_PIX_MAI",t[t.PIX_MAI_INVALID=5]="PIX_MAI_INVALID",t[t.DUPLICATE_PIX_MAI=6]="DUPLICATE_PIX_MAI"}(L||(L={}));var O=function(t){function e(e,n){var r;return(r=t.call(this,e,n)||this).errorCode=e,r.errorName="PIXQR-"+L[e],r}return s(e,t),e}(M);function G(t){return P.apply(this,arguments)}function P(){return(P=i(T.mark((function t(e){return T.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,r.toDataURL(e);case 3:return t.abrupt("return",t.sent.toString());case 7:throw t.prev=7,t.t0=t.catch(0),new O(L.INVALID_QRCODE,"Invalid input string");case 10:case"end":return t.stop()}}),t,null,[[0,7]])})))).apply(this,arguments)}function S(t){return U.apply(this,arguments)}function U(){return(U=i(T.mark((function t(e){var n;return T.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,G(e);case 2:if(null!=(n=t.sent.match(/^data:([A-Za-z-+\/]+);base64,(.+)$/))&&3===n.length){t.next=6;break}throw new O(L.INVALID_QRCODE,"Invalid input string");case 6:return t.abrupt("return",Buffer.from(n[2],"base64"));case 7:case"end":return t.stop()}}),t)})))).apply(this,arguments)}var V=function(){};V.GUI="br.gov.bcb.pix",V.TAG_MAI_CHAVE=1,V.TAG_MAI_INFO_ADD=2,V.TAG_MAI_URL=25;var k,F=function(){function t(t){this.emvQRCode=t}var e=t.prototype;return e.getMAI=function(){return this.emvQRCode.findIdentifiedTemplate(V.GUI,m.MAI_TEMPLATE_FIRST,m.MAI_TEMPLATE_LAST)[0]},t.createCode=function(e){var n=new t(x.createCode(e)),r=n.emvQRCode,a=new D("data",V.GUI,m.TAG_TEMPLATE_GUI),i=r.newTemplateElement(m.MAI_TEMPLATE_FIRST,m.MAI_TEMPLATE_LAST,!0,[a]);return"static"===e.type?(e.chave&&i.newDataElement(V.TAG_MAI_CHAVE,e.chave),e.infoAdicional&&i.newDataElement(V.TAG_MAI_INFO_ADD,e.infoAdicional),e.txid&&r.newTemplateElement(m.TAG_ADDITIONAL_DATA).newDataElement(m.TAG_AD_REF_LABEL,e.txid)):e.url&&i.newDataElement(V.TAG_MAI_URL,e.url),n},t.parseCode=function(e,n){return new t(x.parseCode(e,n))},e.validateCode=function(){var t=i(T.mark((function t(e){return T.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(n=C.get({id:"PIXQR"}).addRule({id:"pix-mai",description:"Contains a PIX Merchant Account Information",rule:function(t){var e=t.emvQRCode.findIdentifiedTemplate(V.GUI,26,51);if(0===e.length)throw new O(L.MISSING_PIX_MAI,"PIX MAI not found");if(e.length>1)throw new O(L.DUPLICATE_PIX_MAI,"PIX MAI duplicated")}}).addRule({id:"pix-static-or-dynamic",description:"Contains a PIX Merchant Account Information",rule:function(t){var e=t.getMAI();if(e.hasElement(V.TAG_MAI_CHAVE)){if(e.hasElement(V.TAG_MAI_URL))throw new O(L.PIX_MAI_INVALID,"PIX MAI contains both CHAVE and URL elements")}else if(!e.hasElement(V.TAG_MAI_URL))throw new O(L.PIX_MAI_INVALID,"PIX MAI contains neither static or dynamic elements")}}),function(t){t.addRule({id:"pix-static-txid",when:function(t){return t.isPIX("static")},description:"Contains a PIX Merchant Account Information",rule:function(){}})}(n),function(t){t.addRule({id:"pix-dynamic-txid",when:function(t){return t.isPIX("dynamic")},description:"Correct URL coded in dynamic PIX",rule:function(t){var e=t.getMAI().getElement(V.TAG_MAI_URL);if(e&&e.content.startsWith("http"))throw new O(L.PIX_MAI_INVALID,"URL must not contain protocol (https://)")}})}(n),n).validate(this,e);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}var n}),t,this)})));return function(e){return t.apply(this,arguments)}}(),e.isPIX=function(t){var e=this.getMAI();if(!e)return!1;var n=e.hasElement(V.TAG_MAI_CHAVE),r=e.hasElement(V.TAG_MAI_URL);switch(t){case"pix":return!0;case"valid":return n||r;case"static":return n;case"dynamic":return r;default:return!1}},e.extractElements=function(){var t,e,n,r,a,i=this.emvQRCode,s=i.extractElements();if(this.isPIX("static"))return o({type:"static"},s,{chave:null==(t=this.getMAI())?void 0:t.getElement(V.TAG_MAI_CHAVE).content,infoAdicional:null==(e=this.getMAI())?void 0:e.getElement(V.TAG_MAI_INFO_ADD).content,txid:null==(n=i.getElement(m.TAG_ADDITIONAL_DATA))||null==(r=n.getElement(m.TAG_AD_REF_LABEL))?void 0:r.content});if(this.isPIX("dynamic"))return o({type:"dynamic"},s,{url:null==(a=this.getMAI())?void 0:a.getElement(V.TAG_MAI_URL).content});throw new O(L.INVALID_QRCODE,"Unable to extract static/dynamic elements")},t.getImage=function(){var t=i(T.mark((function t(e){return T.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",G(e));case 1:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),t.getBase64Image=function(){var t=i(T.mark((function t(e){return T.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",S(e));case 1:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),e.getPayloadData=function(){var t=i(T.mark((function t(e){var n;return T.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.isPIX("dynamic")){t.next=2;break}throw new O(L.INVALID_QRCODE,"You can only get payload data from dynamic pix");case 2:return t.abrupt("return",E(o({url:null==(n=this.getMAI())?void 0:n.getElement(V.TAG_MAI_URL).content},e)));case 3:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}(),t}();(k=exports.PixDynamicStatus||(exports.PixDynamicStatus={})).ATIVA="ATIVA",k.CONCLUIDA="CONCLUIDA",k.REMOVIDA_PELO_USUARIO_RECEBEDOR="REMOVIDA_PELO_USUARIO_RECEBEDOR",k.REMOVIDA_PELO_PSP="REMOVIDA_PELO_PSP";var X={txid:"fc9a4366-ff3d-4964-b5db-c6c91a8722d3",revisao:3,calendario:{criacao:"2020-09-15T19:39:54.013Z",apresentacao:"2020-04-01T18:00:00Z",expiracao:3600},status:exports.PixDynamicStatus.ATIVA,valor:{original:"500.00",final:"500.00",modalidadeAlteracao:0},chave:"7407c9c8-f78b-11ea-adc1-0242ac120002",solicitacaoPagador:"Informar cartão fidelidade",infoAdicionais:[{nome:"quantidade",valor:"2"}]};exports.PIX=V,exports.PIXQRCode=F,exports.PayloadExample=X,exports.default=F;
//# sourceMappingURL=pix-utils.cjs.production.min.js.map
